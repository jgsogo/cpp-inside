<html>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script> 
<script type="text/javascript" src="libcrnd.js"></script>
<script type="text/javascript" src="bundle.js"></script>

<script type="text/javascript">
console.info("CRND JS wrapper");


function help_callback(state, data, status) {
    console.log("> js::help_callback")
    
    var message = crnd.parse_help(data);
    console.log("[js] message.getName: >" + message.getName() + "<");
    console.log("[js] message.getDescription: >" + message.getDescription() + "<");
    console.log("< js::help_callback")
}

function sample_callback(state, data, status) {
    console.log("> js::sample_callback")
    var message = crnd.parse_sample(data);
    draw_histogram(message.getSamplesList(), "LOGNORMAL (3, 0.2)");
    console.log("< js::sample_callback")
}

function functionExists(f) {
	return f && typeof f === "function";
}

Module.onRuntimeInitialized = function() {
    //console.info("Checking functions exist");
    assert(functionExists(Module._help));
    assert(functionExists(Module._sample));

    // Call the help
    /*
    var pointer = addFunction(help_callback);
    var help = Module.cwrap('help', 'void', ['pointer', 'pointer']);
    help(null, pointer);
    removeFunction(pointer);
    */

    // Request sample (LOGNORMAL)
    var model = new crnd.model_pb.Model();
    model.setId(crnd.model_pb.Model.LOGNORMAL);
    model.getParamsMap()["mean"] = 3;
    model.getParamsMap()["stddev"] = 0.2;

    var sample_request = new crnd.sample_request_pb.SampleRequest();
    sample_request.setModel(model);
    sample_request.setSeed(12345);
    sample_request.setNSamples(100000);

    var bytes = serialize_sample_request(sample_request);

    var pointer = addFunction(sample_callback);
    var sample = Module.cwrap('sample', 'void', ['pointer', 'string', 'pointer']);
    console.log("> js::sample");
    sample(null, bytes, pointer);
    console.log("< js::sample");
    removeFunction(pointer);
}

function draw_histogram(rolls, title) {
    var nstars = 300;
    var nclasses = 20;

    var p = [].fill.call({ length: nclasses+1 }, 0);
    var max = Math.max.apply(null, rolls);
    var min = Math.min.apply(null, rolls);
    var step = (max-min)/nclasses;

    rolls.forEach(function (elem, index) {
        idx = Math.round((elem-min)/step);
        p[idx] += 1;
    });

    var h3 = $('<h3></h3>').text(title);
    $("#histogram").append(h3);

    var table = $('<table></table>')

    console.log(title);
    for (var i = 0; i < nclasses; i++) {
        var axis_x = (min+i*step+step/2).toFixed(6).padStart(9, "0");
        var npstars = Math.round(p[i]*nstars/rolls.length);
        
        console.log(axis_x + ": " + "*".repeat(npstars));
        table.append("<tr><td>" + axis_x + "</td><td>" + "*".repeat(npstars) + "</td></tr>");
    }
    $("#histogram").append(table);
}

</script>


<body>

<div id="histogram">
    
</div>

</body>
</html>
