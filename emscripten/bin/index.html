<html>
<body>
<script type="text/javascript" src="libcrnd.js"></script>
<script type="text/javascript" src="bundle.js"></script>

<script type="text/javascript">
console.info("CRND JS wrapper");


function help_callback(state, data, status) {
    console.log("> js::help_callback")
    
    var message = crnd.parse_help(data);
    console.log("[js] message.getName: >" + message.getName() + "<");
    console.log("[js] message.getDescription: >" + message.getDescription() + "<");
    console.log("< js::help_callback")
}

function sample_callback(state, data, status) {
    console.log("> js::sample_callback")
    var message = crnd.parse_sample(data);

    console.log("< js::sample_callback")
}

function functionExists(f) {
	return f && typeof f === "function";
}

Module.onRuntimeInitialized = function() {
    //console.info("Checking functions exist");
    assert(functionExists(Module._help));
    assert(functionExists(Module._sample));

    // Call the help
    /*
    var pointer = addFunction(help_callback);
    var help = Module.cwrap('help', 'void', ['pointer', 'pointer']);
    help(null, pointer);
    removeFunction(pointer);
    */

    // Request sample (LOGNORMAL)
    var model = new crnd.model_pb.Model();
    model.setId(crnd.model_pb.Model.LOGNORMAL);
    model.getParamsMap()["mean"] = 3;
    model.getParamsMap()["stddev"] = 0.2;

    var sample_request = new crnd.sample_request_pb.SampleRequest();
    sample_request.setModel(model);
    sample_request.setSeed(12345);
    sample_request.setNSamples(100000);

    var bytes = serialize_sample_request(sample_request);

    var pointer = addFunction(sample_callback);
    var sample = Module.cwrap('sample', 'void', ['pointer', 'string', 'pointer']);
    console.log("> js::sample");
    sample(null, bytes, pointer);
    console.log("< js::sample");
    removeFunction(pointer);
}

</script>

</body>
</html>
